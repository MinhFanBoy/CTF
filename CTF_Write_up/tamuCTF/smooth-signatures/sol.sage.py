

# This file was *autogenerated* from the file sol.sage
from sage.all_cmdline import *   # import sage library

_sage_const_1 = Integer(1); _sage_const_2 = Integer(2); _sage_const_23 = Integer(23); _sage_const_24 = Integer(24); _sage_const_0p5 = RealNumber('0.5'); _sage_const_443 = Integer(443); _sage_const_65537 = Integer(65537); _sage_const_0 = Integer(0)
from gmpy2 import *
import math
from pwn import *
from tqdm import tqdm
from hashlib import sha256
from Crypto.Util.number import *

def lcm(a, b):
    return (a * b) // GCD(a, b)

def check(s,h,r,e,modulus):
    return (pow(s, e, modulus) - pow(h, _sage_const_1 , modulus) - pow(r, e, modulus)) % modulus


def sieve_of_eratosthenes_24bit():
    lower_limit = _sage_const_2 **_sage_const_23 
    upper_limit = _sage_const_2 **_sage_const_24  
    primes = [True] * (upper_limit - lower_limit)

    for i in range(_sage_const_2 , int(upper_limit ** _sage_const_0p5 ) + _sage_const_1 ):
        if primes[i]:
            for j in range(max(i*i, (lower_limit + i - _sage_const_1 ) // i * i), upper_limit, i):
                primes[j - lower_limit] = False

    prime_numbers = [i for i in range(lower_limit, upper_limit) if primes[i - lower_limit]]
    return prime_numbers

io = remote("tamuctf.com", _sage_const_443 , ssl=True, sni="smooth-signatures")
e = _sage_const_65537 
io.recvuntil(b'\n',drop=True)
io.recvuntil(b'\n',drop=True)

res = io.recvuntil(b'Give the oracle a message to sign: ')
msg = b'Giang_dz_vcl'
io.sendline(msg)
io.recvuntil(b'Your verification signature is ')
res = io.recvuntil(b'\n',drop=True).decode()
r1,s1 = map(int, res.strip("()").split(","))

res = io.recvuntil(b'Give the oracle another message to sign: ')
msg = b'Giang_dz_vcl'
io.sendline(msg)
io.recvuntil(b'Your second verification signature is ')
res = io.recvuntil(b'\n',drop=True).decode()
r2,s2 = map(int, res.strip("()").split(","))
h = bytes_to_long(sha256(msg).digest())

# n = GCD(pow(s1,e)-h-pow(r1,e),pow(s2,e)-h-pow(r2,e))

primes = sieve_of_eratosthenes_24bit()
primes_n = []
n = _sage_const_1 
for i in tqdm(range(len(primes))):
    res1 = check(s1,h,r1,e,primes[i])
    res2 = check(s2,h,r2,e,primes[i])
    if res1 == _sage_const_0  and res2 == _sage_const_0 :
        n= n*primes[i]
        primes_n.append(primes[i])

q = _sage_const_1 
for p in primes_n:
    q = lcm(q,p-_sage_const_1 )
d = pow(e,-_sage_const_1 ,q)

io.recvuntil(b'Ask the oracle a question: ')
msg = b"What is the flag?"
io.sendline(msg)
h = bytes_to_long(sha256(msg).digest())
r = pow(h,d,n)
s = pow(_sage_const_2 *h,d,n)
io.recvuntil(b"Give the verification signature: ")
send = str(r) + "," + str(s)
io.sendline(send.encode())
flag = io.recvuntil(b'\n',drop=True)
print(flag)

