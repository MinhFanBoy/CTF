

# This file was *autogenerated* from the file chal.sage
from sage.all_cmdline import *   # import sage library

_sage_const_16 = Integer(16); _sage_const_4 = Integer(4); _sage_const_128 = Integer(128); _sage_const_0 = Integer(0); _sage_const_1 = Integer(1); _sage_const_3 = Integer(3)#!/usr/bin/env sage
import os, json, random
from hashlib import md5
from Crypto.Cipher import DES

FLAG = os.getenv("FLAG", "bi0sctf{fake_flag}")
randomness = os.urandom(_sage_const_16 )
SECRET = os.urandom(_sage_const_16 )
server_seed = os.urandom(_sage_const_4 )

def gen_rand(user_seed, server_seed):
    return DES.new(user_seed + server_seed, DES.MODE_ECB).encrypt(randomness)

def encode(data):
    P = ComplexField(_sage_const_128 )['x']; (x,) = P._first_ngens(1)
    poly = _sage_const_0 
    for i in range(len(data)):
        poly += data[i] * x ** i
    return poly.roots()[_sage_const_1 ][_sage_const_0 ]

seen_seeds = set()

for i in range(_sage_const_3 ):
    try:
        user_input = json.loads(input())
        option = user_input.get("option")
        if option == "get_secret":
            user_seed = os.urandom(_sage_const_4 )
            seen_seeds.add(user_seed)
            encoded_secret = encode(SECRET)
            error = encode(gen_rand(user_seed, server_seed))
            print(json.dumps({"encoded_secret": str(encoded_secret + error), "user_seed": user_seed.hex()}))
        elif option == "encode":
            data = bytes.fromhex(user_input.get("data"))
            user_seed = bytes.fromhex(user_input.get("user_seed"))
            if len(data) != _sage_const_16  or len(user_seed) != _sage_const_4 :
                print(json.dumps({"error": "Invalid input"}))
                continue
            if user_seed in seen_seeds:
                print(json.dumps({"error": "Seed already used"}))
                continue
            seen_seeds.add(user_seed)
            encoded_data = str(encode(data) + encode(gen_rand(user_seed, server_seed)))
            print(json.dumps({"encoded_data": encoded_data}))
        elif option == "verify":
            user_secret = bytes.fromhex(user_input.get("user_secret"))
            if user_secret == SECRET:
                print(json.dumps({"flag": FLAG}))
            else:
                print(json.dumps({"error": "Invalid secret"}))
        else:
            print(json.dumps({"error": "Invalid option"}))
    except Exception as e:
        print(json.dumps({"error": "Invalid input"}))
        continue

